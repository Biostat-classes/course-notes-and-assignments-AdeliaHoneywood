---
title: Combining (lots of) numerical and categorical predictors
subtitle: ANCOVAs and beyond
bibliography: ../references.bib
---

<!-- COMMENT NOT SHOW IN ANY OUTPUT: Code chunk below sets overall defaults for .qmd file; these inlcude showing output by default and looking for files relative to .Rpoj file, not .qmd file, which makes putting filesin different folders easier  -->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())
```

So far we've used linear models to consider how categorical predictors
and continuous numerical predictors can predict continuous outcomes.
We've already considered having multiple categorical predictors
(remember factorial ANOVAs). Now we'll extend those ideas to models
where we have numerous categorical and/or continuous numerical
predictors in the same model. In doing so we'll introduce (and connect)
ANCOVAs, multiple regression, and model selection.

## Back to the iris data

We will motivate this (again!) with an example from our favorite iris
data. So far we have considered how species impacts sepal lengths
(abbreviated analysis:

```{r}
library(Rmisc)
function_output <- summarySE(iris, measurevar="Sepal.Length", groupvars =
                               c("Species"))

library(ggplot2)
ggplot(function_output, aes(y=Sepal.Length, x=Species, fill=Species)) +
  geom_col(aes(fill=Species)) +
    geom_errorbar(aes(ymin=Sepal.Length-ci, ymax=Sepal.Length+ci)) +
  labs(title=expression(paste("Sepal lengths of ",italic("I. species"))),
       y= "Sepal length (cm)",
       x= "Species")
```

```{r}
iris_anova <- lm(Sepal.Length~Species, iris)
plot(iris_anova)
library(car)
Anova(iris_anova, type="III")
library(multcomp)
compare_cont_tukey <- glht(iris_anova, linfct = mcp(Species = "Tukey"))
summary(compare_cont_tukey)
```

We've also considered how petal length influences sepal length
(abbreviated analysis:

```{r}
ggplot(iris, aes(y=Sepal.Length, x=Petal.Length)) +
  geom_point() +
  labs(title="Sepal length increases with petal length",
       y= "Sepal length (cm)",
       x= "Petal Length (cm)") +
  geom_smooth(method = "lm",se = F)

```

```{r}
iris_regression <- lm(Sepal.Length ~ Petal.Length, iris)
plot(iris_regression)
Anova(iris_regression, type = "III")
summary(iris_regression)
```

However, what if we wanted to consider the combined (and potentially
interacting) effects of petal length and species on sepal length? This
is like our 2-way ANOVA but with one predictor being continuous. This is
often called an ANCOVA, but it's just another linear model! Overall, we
are decomposing the variance of each data point among various factors.
Our use of type III residuals let's us ask how much any given factor
explains *given* that other factors are in the model (we'll explore this
more below). Put another way, we might want to know if a factor adds
explanatory power to the model (and is not redundant or subsumed by
another factor).

Continuing to use focal iris dataset, we can use the same format we used
for factorial or 2-way ANOVAs to add the factors.

```{r}
iris_ancova <- lm(Sepal.Length~Species*Petal.Length, iris)
```

This model includes an interaction and matche the following null
hypotheses (note 2 are copied from previous sections!):

$$
\begin{split}
H_O: \mu_{sepal \ length, \ setosa} = \mu_{sepal \ length, \ virginica} = \mu_{sepal \ length, \ versicolor}\\ 
H_O: \beta_\textrm{(coefficient between sepal and petal length)} = 0\\\\
H_O: \textrm{relationship between petal length and sepal length does not differ
among species}\\
\end{split}
$$ Once we develop the model, we can visually check the assumptions,
which remain

$$
\epsilon \approx i.i.d.\ N(\mu,\sigma)
$$

```{r}
plot(iris_ancova)
```

If assumptions appear to be met (as they do here), we can consider
impacts of factors. Given the presence of categorical predictors, an
Anova table may be informative

```{r}
Anova(iris_ancova, type="III")
```

Once here we again have the same 2 options we noted in factorial ANOVAs.

1.  We can read results from the full model. These show no interaction
    between species and petal length (F~2,144~ = 1.68, p = 0.1895) and
    no impact of petal length (F~1,144~=3.83, p = 0.052) but a
    significant impact of species (F~2,144~ = 12.81, p \< 0.01). We can
    follow this up with a post-hoc test

    ```{r}
    compare_ancova_tukey <- glht(iris_ancova, linfct = mcp(Species = "Tukey"))
    summary(compare_ancova_tukey)
    ```

which suggests *I. versicolor* and *I. virginica* are similar to each
other but different from other species.

However, note the *glht* output notes interactions are still present in
model, so this approach may be inappropriate. For ANOVA's we noted could
instead compare means for each combination.

```{r}
library(emmeans)
emmeans(iris_ancova, pairwise ~ Species*Petal.Length)
```

This approach, however, is less useful for numerical predictors. By
default the **emmeans** package uses the average for the covariate
(note,

```{r}
mean(iris$Petal.Length)
```

is why we see *3.578* spread throughout the output). While

To illustrate how this works, let's pretend we visit another valley and
sample 3 new iris species (*I. baruch*, *I. hunter*, and *I. york)*. We
might want to see

```{r}
set.seed(19)
iris_example_species <-data.frame(
  Species = c(rep("baruch",25), rep("hunter", 25), rep("york", 25)),
  Sepal_Length = runif(75,2,4 ),
  #no difference based on species or sepal length
  Petal_no_impacts = runif (75, 4, 6))
#no difference based on species
iris_example_species$Petal_no_impact_species <- 
  iris_example_species$Sepal_Length * 2 + rnorm(75)
#no impact of petal length
iris_example_species$Petal_no_relationship <-rnorm(75) +
  c(rep(2,25), rep(3,25), rep(4,25))
#impact of species and petal length but no interaction
iris_example_species$Petal_no_interaction <- 
  iris_example_species$Sepal_Length * 2 + rnorm(75) +
  c(rep(2,25), rep(3,25), rep(4,25))
#impact of species and petal length with interaction
iris_example_species$Petal_interaction <- 
  iris_example_species$Sepal_Length * c(rep(-2, 25),rep(2,25), rep(5,25)) + 
  c(rep(2,25), rep(3,25), rep(4,25)) + rnorm(75)
```

## Next steps
